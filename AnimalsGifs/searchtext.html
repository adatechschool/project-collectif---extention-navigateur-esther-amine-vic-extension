<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <style>


      </style>
    
    <title>Document</title>
</head>
<body>

    <div id="popupcontent">This is a popup window!</div>
    <p id="paragraph">
        Ce qu'il faut surtout retenir, c'est qu'entre le désert et l'oasis apparaît assez fréquemment un type intermédiaire, la steppe. Steppe à peu près permanente, quand elle doit son existence à la présence d'une nappe souterraine; steppe fort intermittente, quand elle dépend des pluies d'orage; dans tous lors cas, région de floraison soudaine, peuplée de plantes xérophytes : graminées courtes, dures touffes de drinn, buissons épineux de retem et d'acacia gommier, que le retour de la sécheresse semble plonger dans le néant, mais qui sont douées d'une étonnante vitalité et qui parviennent à sauver, à travers les longues épreuves de sécheresse, leurs racines ou leurs graines.
La vie animale, comme la vie végétale, réussit à se maintenir dans un milieu qui ne s'y prête guère; mais, comme les plantes, les animaux sont absents des régions absolument désertiques tout au plus s'y réfugient-ils quand ils sont poursuivis. 
</p>
<p>
oasis. Ils remédient à la rareté de l'eau et à la pénurie d'aliments qui en résulte soit par une grande mobilité (lièvre, gazelle, etc.), soit par des réserves analogues à celles des plantes (bosse du chameau, intestin de l'antilope adax), soit par de longs engourdissements dans le sol (lézards, serpents), dans tous les cas, par une exceptionnelle résistance.
</p>
    <script>
 var liste = ["oasis", "gazelle"] // a modifier pour inclure liste d'animaux 

// on boucle sur la liste pour highlight chaque mot trouve dans la page
 for (element of liste) {
     highlight(element)
 }

// permet de mettre en evidence les mots trouvés dans la page 
function highlight(search) {
  var paragraph = document.getElementsByTagName('p');
 // on boucle sur tous les paragraphes de la page pour y chercher 
// le terme et le remplacer par lui-même entouré de balises <mark></mark>
  for (p of paragraph) {
  search = search.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); //https://stackoverflow.com/questions/3446170/escape-string-for-use-in-javascript-regex
  var re = new RegExp(search, 'g');
  p.innerHTML = p.innerHTML.replace(re, `<mark class="animal">$&</mark>`);
  }
}

// on boucle sur chaque mot surligné pour lui ajouter un ID et un event listener 
var animals = document.getElementsByClassName("animal")
let i = 0

for (anim of animals) {
    anim.id = i.toString();
    let currEl = document.getElementById(i.toString())
    currEl.addEventListener("click", () => {showPopup(currEl)})
    i++;
}

// variable générale qui permettra de récupérer
// l'emplacement du gif et de lui assigner une source
var myGif

// crée le gif en temps qu'enfant de l'élément cliqué
// et le fait apparaitre comme un popup
function showPopup(element) { 

  var gif = document.createElement("img")
  gif.id = element.innerText + element.id
    element.appendChild(gif)

  element.style.position = "relative"
    gif.style.position = "absolute"
    gif.style.top = "5px"
    gif.style.left = "5px" 
    console.log(gif.id)
    myGif = gif
    getGif(element.innerText)
}

// appelle l'API Giphy avec le terme recherché 
function getGif(searchterm) {

    var gifurl = "https://api.giphy.com/v1/gifs/search?api_key=lNEB9ueK0HjLAyPTh0pTfO6hAfRb09Sx&q=" + searchterm + "&limit=1&offset=0&rating=g&lang=en"
 
    $.get(gifurl, callBackGetSuccess).done(function() {
        //alert( "second success" );
      })
      .fail(function() {
        alert( "error" );
      })
      .always(function() {
        //alert( "finished" );
      }); 
}

// donne l'url du gif comme src de l'image créée par showPopup 
var callBackGetSuccess = function(d) {
   console.log("donnees api", d)
   myGif.src = d.data[0].images.fixed_height_small.url;
}

// To-Do : 
// gérer le cas où pas de résultat 
// empêcher nouveau popup de s'ouvrir si on a pas fermé le précédent 
// remplacer onClick par onmouseover 
// créer fonction pour fermer le popup quand le mouseover est terminé  

    </script>
</body>
</html>